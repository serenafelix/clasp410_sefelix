#!/usr/bin/env python3

"""
This is my final project code script. It contains an explicit finite-difference Stefan ice growth model with nucleation.

It also contains functions to solve and plot the results for questions 1-5 outlined in the lab assignment.
"""

#imports
import numpy as np
import matplotlib.pyplot as plt
import scipy.interpolate as interp

#Temps
Temp_array_2000 = np.array([-2.2,2.8,5.2,-0.3,-3,-3.5,-1.4,-4,3,1.7,3.8,-1.2,-5.2,-11.2,
                            -7.2,-2.4,-8.6,-11.4,-8,-7.5,-13.2,-15.3,-12.9,-9,-12.1,-10.7,
                            -14.7,-13.1,-9.5,-9.1,-5.7,-4,-9.6,-8.6,-2.2,-5.5,-5.5,-5.4,-8.5,-8.1,1,
                            -3.6,-11.1,-10.3,-4.7,-6.5,-2,-9.3,-10.3,-5.8,-4.6,-4,0.3,6.7,8.5,7.8,8,11.5,
                            3.6,4.4,7.2,4.1,0,2.4,5.7,3.8,7.9,15.3,	19.3,4.8,-5.3,-2.7,0,-0.1,6.2,5.5,-2.7,
                            -3.2,0.2,4.6,6.8,7.2,9.2,10.3,13.1,9.3,9.4,6.1,6.4,2.7,4.4,8.3,10.3,9,8.4,
                            -0.5,4.4,4,	0.3,-0.7,-0.1,1.4,-0.2,2.6,5.3,14.8,13,4,5.9,10,7.6,6.4,4.6,7.7,
                            9.9,7.7,6.7,8.1,9.1,11.9,7.3,12.7,11.4,11.7,17.9,20.7,22.8,25,24.1,23,13.3,13.2,	
                            13,19,11,8.3,11.3,9.8,14.1,8.5,7.5,10.6,14.8,17.1,16.8,16,13.1,15.1,14.1,12.7,
                            14.5,17.4,18.7,17.6,12,14.4,15.4,13,16.6,18.8,24,24.8,27,18,14.2,17.9,24.2,20.1,	
                            20.3,16.6,17.4,20.7,22.5,22.2,19.1,22.6,22.6,23,21.4,17.8,17.4,16.4,19.7,22.6,23.2,
                            18.1,20.8,19.2,15.1,16.9,18.5,23.1,17.6,18.2,19,23,21.8,19.4,20,20.8,16.6,15.7,17.7,
                            15.7,16.5,16.6,18.8,22,23.3,23.7,22,21.3,19.9,22.7,22.6,20.1,16.4,18.3,20.6,21.9,23.1,	
                            22.8,21.2,19.7,18.7,19.9,20.1,23.2,21.3,17.9,15.3,15.8,14.5,14.4,17,20.8,20.2,19.6,21.3,
                            22.8,19.4,21.5,23,21.2,23.8,24.6,19,20,12.8,11.4,15,20.2,21.4,23.4,20.1,21.3,15.1,16.4,
                            13.4,10.1,12.2,16,17.8,21.7,13.1,9,10.4,11.8,7.6,8,11.5,8.6,7.4,13.1,17,19.3,16.2,15.2,	
                            13,10.2,6.1,5.3,3.6,6.3,9.4,11.7,13.4,18.2,17.2,9.8,10,10,11.2,10.7,16.1,9.9,9.9,12.8,12.7,	
                            11.8,17.5,13,2.9,4.8,6,6.8,11.6,13.9,11.1,5.2,7.2,9,8.4,8.9,8.9,4.3,3.9,4.1,2.5,1.9,1.5,2,
                            0.1,-1.3,-0.2,-1.5,-4.6,-5.7,-4.4,-0.6,1.7,3.5,2.2,0.8,1.1,0.4,-2,-5.6,-2.4,-2.2,-8.4,-9.8,	
                            -9.1,-8.2,-8.1,-3.5,-6.9,-9.6,-9.7,-6.9,-4,0.7,-6.9,-9.9,-11.3,-8.9,-12.2,-15.9,-13,-13.6,-13,-8.6,-13.9,-12.6,-4.9,-5.5])

def simulate_temps(mean_temp, annual_amplitude, noise_std=0, days_in_year=365, seed=42):
    """
    Simulate daily temperatures over a year with seasonal cycle and random noise.

    Parameters:
    mean_temp : float : mean annual temperature (°C)
    annual_amplitude : float : amplitude of seasonal temperature variation (°C)
    noise_std : float : standard deviation of daily temperature noise (°C)
    days_in_year : int : number of days in the year
    seed : int : random seed for reproducibility

    Returns:
    temperatures : array of daily temperatures (°C)
    """
    np.random.seed(seed)  # fixed seed for reproducibility
    days = np.arange(days_in_year) # array of days
    
    # seasonal cycle: cosine function
    seasonal_cycle = -annual_amplitude * np.cos(2 * np.pi * days / days_in_year)
    
    # random noise
    noise = np.random.normal(0, noise_std, days_in_year)
    
    # total temperatures
    temperatures = mean_temp + seasonal_cycle + noise
    
    return temperatures

def ice_growth(Ts_array, k=2.2, lam=3.34e5, rho=917, Tm=0, h_init=0.0, dt=1.0, nucleation_rate=0.01):
    """
    Explicit finite-difference Stefan ice growth model with nucleation.
    
    Parameters:
    Ts_array : array of daily temperatures (°C)
    k : thermal conductivity of ice (W/m/K)
    lam : latent heat of fusion (J/kg)
    rho : density of ice (kg/m^3)
    Tm : melting/freezing point of water (°C)
    h_init : initial ice thickness (m)
    dt : time step (days)
    nucleation_rate : growth rate for newly forming ice (m/day per °C)
    
    Returns:
    h : ice thickness over time
    """
    n_days = len(Ts_array) # number of days to run the model
    h = np.zeros(n_days) # initialize ice thickness array
    h[0] = h_init # set initial ice thickness

    # Stefan constant, converts to m/day
    C = 86400 * k / (lam * rho)
    
    # time-stepping loop
    for n in range(n_days-1):
        if h[n] > 0:
            # Stefan growth/melt
            h_eff = max(h[n], 0.001)  # prevent division by zero
            dh = C * (Tm - Ts_array[n]) / h_eff * dt
        else:
            # implement nucleation (creates smaller growth when ice is absent)
            dh = nucleation_rate * max(Tm - Ts_array[n], 0) * dt
        
        h[n+1] = max(h[n] + dh, 0)  # enforce non-negative thickness
    
    return h

def question_one():
    """
    Simulate daily temperatures and plot ice thickness over a year.
    """
    temps = simulate_temps(mean_temp=9, annual_amplitude=10, noise_std=2) # simulate temperatures
    h = ice_growth(temps, h_init=0.0, dt=1.0, nucleation_rate=0.01) # simulate ice growth
    days = np.arange(len(temps)) # array of days
    plt.figure(figsize=(10, 6))
    plt.plot(days, h, label='Ice Thickness', color='blue') # plot results
    plt.xlabel('Days')
    plt.ylabel('Ice Thickness (m)')
    plt.title('Ice Thickness Over One Year with Simulated Temperatures')
    plt.grid()
    plt.show()

def question_two():
    """
    Solve and plot ice thickness over the year 2000 in Saginaw Bay.
    """
    # use the provided Temp_array_2000 for temperatures
    h = ice_growth(Temp_array_2000, h_init=0.0, dt=1.0, nucleation_rate=0.01)
    days = np.arange(len(Temp_array_2000)) # array of days
    plt.figure(figsize=(10, 6))
    plt.plot(days, h, label='Ice Thickness', color='blue') # plot results
    plt.xlabel('Days')
    plt.ylabel('Ice Thickness (m)')
    plt.title('Ice Thickness Over the Year 2000 in Saginaw Bay')
    plt.grid()
    plt.show()

def question_three():
    """
    Explore sensitivity of ice thickness to different thermal conductivity and latent heat of fusion values.
    """
    thermal_conductivities = [1.5, 2.2, 3.0]  # different k values to test
    days = np.arange(len(Temp_array_2000)) # array of days
    plt.figure(figsize=(10, 6))
    
    for k in thermal_conductivities:
        h = ice_growth(Temp_array_2000, k=k) # simulate ice growth
        plt.plot(days, h, label=f'k = {k} W/m/K') # plot results
    
    plt.xlabel('Days')
    plt.ylabel('Ice Thickness (m)')
    plt.title('Sensitivity of Ice Thickness to Thermal Conductivity')
    plt.legend()
    plt.grid()
    plt.show()

    latent_heats = [2.5e5, 3.34e5, 4.0e5]  # different latent heat values to test
    plt.figure(figsize=(10, 6))

    for lam in latent_heats:
        h = ice_growth(Temp_array_2000, lam=lam) # simulate ice growth
        plt.plot(days, h, label=f'Latent Heat = {lam} J/kg') # plot results
    
    plt.xlabel('Days')
    plt.ylabel('Ice Thickness (m)')
    plt.title('Sensitivity of Ice Thickness to Latent Heat of Fusion')
    plt.legend()
    plt.grid()
    plt.show()

def question_four():
    """
    Explore sensitivity of ice thickness to different nucleation rates.
    """
    nucleation_rates = [0.0, 0.005, 0.01, 0.02]  # different nucleation rates to test
    days = np.arange(len(Temp_array_2000)) # array of days
    plt.figure(figsize=(10, 6))
    
    for rate in nucleation_rates:
        h = ice_growth(Temp_array_2000, h_init=0.0, dt=1.0, nucleation_rate=rate) # simulate ice growth
        plt.plot(days, h, label=f'Nucleation Rate: {rate} m/day/°C') # plot results
    
    plt.xlabel('Days')
    plt.ylabel('Ice Thickness (m)')
    plt.title('Sensitivity of Ice Thickness to Nucleation Rate')
    plt.legend()
    plt.grid()
    plt.show()

def question_five():
    """
    Explore climate change scenarios by increasing annual temperatures by 2°C and 4°C.
    """
    temp_increases = [0, 2, 4]  # temperature increases to test
    days = np.arange(len(Temp_array_2000)) # array of days
    plt.figure(figsize=(10, 6))
    
    for increase in temp_increases:
        Ts_increased = Temp_array_2000 + increase # increase temperatures
        h = ice_growth(Ts_increased, h_init=0.0, dt=1.0, nucleation_rate=0.01) # simulate ice growth
        plt.plot(days, h, label=f'Temperature Increase: {increase}°C') # plot results
    
    plt.xlabel('Days')
    plt.ylabel('Ice Thickness (m)')
    plt.title('Impact of Climate Change on Ice Thickness')
    plt.legend()
    plt.grid()
    plt.show()
